name: Detect C# Services

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: false
        default: 'staging'
      version:
        description: 'Version to deploy'
        required: false
        default: '1.0.0'
      
jobs:
  detect-services:
    runs-on: ubuntu-latest

    outputs:
      services: ${{ steps.detect.outputs.services }}
      changed_services: ${{ steps.changed.outputs.changed_services }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ----------------------------------------------------------
      # STEP 1 — Detect services by .sln files ONLY
      # ----------------------------------------------------------
      - name: Detect service root folders (.sln-based)
        id: detect
        run: |
          echo "Detecting services via .sln files..."

          # Find directories that contain .sln files
          SERVICES=$(find Backend -type f -name "*.sln" -printf '%h\n' | sort -u)

          echo "Detected services:"
          echo "$SERVICES"

          # Convert to JSON array
          JSON=$(printf '%s\n' "$SERVICES" | jq -R . | jq -s -c .)
          echo "services=$JSON" >> "$GITHUB_OUTPUT"

      # ----------------------------------------------------------
      # STEP 2 — Detect changed services
      # ----------------------------------------------------------
      - name: Detect changed services
        id: changed
        run: |
          echo "Detecting changed services..."

          # Get changed files for PR or push
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} HEAD)
          else
            FILES=$(git diff --name-only HEAD~1 HEAD)
          fi

          echo "Changed files:"
          echo "$FILES"

          CHANGED=()

          for service in $(echo '${{ steps.detect.outputs.services }}' | jq -r '.[]'); do
            if echo "$FILES" | grep -q "^${service}/"; then
              CHANGED+=("$service")
            fi
          done

          JSON=$(printf '%s\n' "${CHANGED[@]}" | jq -R . | jq -s -c .)
          echo "changed_services=$JSON" >> "$GITHUB_OUTPUT"

      - name: Summary
        run: |
          echo "All services:"
          echo '${{ steps.detect.outputs.services }}'
          echo "Changed services:"
          echo '${{ steps.changed.outputs.changed_services }}'
          
      - name: Detect frontend projects (one-level only)
        id: frontend
        run: |
          echo "Detecting frontend projects (one-level deep)..."
      
          CONFIG="Configurations/frontend_Structure.json"
          ROOTS=$(jq -r '.frontendRoots[]' "$CONFIG")
          PROJECTS=()
      
          for root in $ROOTS; do
            echo "--- Scanning root: $root ---"
      
            if [ -d "$root" ]; then
      
              # Check only 1-level subfolders
              for project in $(find "$root" -maxdepth 1 -mindepth 1 -type d); do
      
                # Only accept folders containing package.json
                if [ -f "$project/package.json" ]; then
                  echo "Detected frontend project: $project"
                  PROJECTS+=("$project")
                else
                  echo "Skipping $project (no package.json)"
                fi
      
              done
      
            else
              echo "Root folder $root does not exist, skipping."
            fi
          done
      
          # Make unique
          UNIQUE=$(printf "%s\n" "${PROJECTS[@]}" | sort -u)
      
          echo "FINAL DETECTED FRONTEND PROJECTS:"
          printf "%s\n" "${UNIQUE[@]}"
      
          JSON=$(printf "%s\n" "${UNIQUE[@]}" | jq -R . | jq -s -c .)
          echo "frontend_projects=$JSON" >> "$GITHUB_OUTPUT"
